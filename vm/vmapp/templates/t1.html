<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Brookshear VM</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                display: flex;
                flex-direction: column;
                padding: 20px;
                background-color: #f8f9fa;
                color: #333;
                height: 100vh;
                box-sizing: border-box;
                overflow: hidden;
            }
            .container {
                display: flex;
                flex-direction: row;
                gap: 20px;
                width: 100%;
                //overflow: visible;
                align-items: stretch;
            }
            .memory,
            .registers,
            .controls {
                background-color: #fff;
                border: 1px solid #ccc;
                border-radius: 8px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                padding: 20px;
                height: calc(100vh - 40px);
                overflow-y: scroll;
                flex: 1;
            }
            .memory {
                overflow-x: hidden;
            }
            .memory h2,
            .registers h2,
            .controls h2 {
                text-align: center;
                margin-bottom: 10px;
            }
            .memory table,
            .registers table {
                width: 100%;
                border-collapse: collapse;
            }
            .memory th,
            .memory td,
            .registers th,
            .registers td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: center;
            }
            .memory th,
            .registers th {
                background-color: #f1f1f1;
            }
            .controls {
                flex-grow: 1.3;
                overflow-y: scroll;
            }
            .control-buttons {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                justify-content: center;
                margin-bottom: 20px;
            }
            .control-buttons button {
                background-color: #007bff;
                color: #fff;
                border: none;
                padding: 10px 20px;
                border-radius: 4px;
                cursor: pointer;
                transition: background-color 0.3s;
            }
            .control-buttons button:hover {
                background-color: #0056b3;
            }
            .controls div {
                margin-bottom: 10px;
                text-align: center;
            }
            .controls label {
                display: block;
                margin-bottom: 5px;
            }
            .controls input[type="text"],
            .controls input[type="range"],
            .controls textarea {
                width: 80%;
                padding: 5px;
                border-radius: 4px;
                border: 1px solid #ccc;
                overflow-y: scroll;
            }

            .assembly-machine-container {
                display: flex;
                flex-direction: row;
                gap: 20px;
            }
            .display-container {
                align-items: center;
                margin-top: 20px;
                width: 640px;
                height: 640px;
            }
            #display-canvas {
                border: 1px solid #000;
                margin-bottom: 10px;
                align-items: stretch;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="memory">
                <h2>Memory</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Addr</th>
                            <th>Binary</th>
                            <th>Hex</th>
                            <th>Integer</th>
                            <th>Float</th>
                        </tr>
                    </thead>
                    <tbody id="memory-data">
                        <!-- Memory data will be inserted here -->
                    </tbody>
                </table>
            </div>
            <div class="registers">
                <h2>Registers</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Reg</th>
                            <th>Binary</th>
                            <th>Hex</th>
                            <th>Integer</th>
                            <th>Float</th>
                        </tr>
                    </thead>
                    <tbody id="registers-data">
                        <!-- Register data will be inserted here -->
                    </tbody>
                </table>
                <div class="display-container">
                    <canvas
                        id="display-canvas"
                        width="640"
                        height="640"
                    ></canvas>
                </div>
            </div>
            <div class="controls">
                <h2>Controls</h2>
                <div class="control-buttons">
                    <button onclick="loadMachineCode()">Load</button>
                    <button onclick="resetVM()">Reset</button>
                    <button onclick="doStep()">Step</button>
                    <button onclick="runVM()">Run</button>
                    <button onclick="toggleDisplay()">Display On/Off</button>
                    <button onclick="saveDisplay()">Save Display</button>
                </div>
                <div>
                    <label>Program Counter:</label>
                    <input
                        type="text"
                        id="program-counter"
                        value="00"
                        readonly
                    />
                </div>
                <div>
                    <label>Instruction Register:</label>
                    <input
                        type="text"
                        id="instruction-register"
                        value="0000"
                        readonly
                    />
                </div>
                <div>
                    <label>Opcode:</label>
                    <input type="text" id="opcode" value="0" readonly />
                </div>
                <div>
                    <label>Operands:</label>
                    <input type="text" id="operands" value="0,0,0" readonly />
                </div>
                <div>
                    <label>Speed:</label>
                    <input
                        type="range"
                        id="speed"
                        min="0"
                        max="100"
                        value="50"
                        onchange="updateSpeed()"
                    />
                </div>
                <form id="upload-form" enctype="multipart/form-data">
                    <label for="input-file">Upload Assembly Code File:</label>
                    <input type="file" id="input-file" name="input_file" />
                    {% csrf_token %}
                    <button type="submit">Assemble</button>
                </form>
                <div class="assembly-machine-container">
                    <div>
                        <label>Assembly Code:</label>
                        <div id="assembly-code" class="scroll-box"></div>
                    </div>
                    <div>
                        <label>Machine Code:</label>
                        <div id="machine-code" class="scroll-box"></div>
                    </div>
                </div>
           
            </div>
        </div>

        <script>
            const memoryData = document.getElementById("memory-data");
            const registersData = document.getElementById("registers-data");
            const programCounter = document.getElementById("program-counter");
            const instructionRegister = document.getElementById(
                "instruction-register",
            );
            const opcode = document.getElementById("opcode");
            const operands = document.getElementById("operands");
            const assemblyCode = document.getElementById("assembly-code");
            const machineCode = document.getElementById("machine-code");
            const displayCanvas = document.getElementById("display-canvas");
            const ctx = displayCanvas.getContext("2d");
            let displayOn = true;
            let startTime;
            let stepDelay = 500; // Default to 500ms per step

            function updateUI(data) {
                loadMemory(data.memory);
                loadRegisters(data.registers);
                programCounter.value = data.program_counter
                    .toString(16)
                    .padStart(2, "0")
                    .toUpperCase();
                instructionRegister.value = data.instruction_register
                    .toString(16)
                    .padStart(4, "0")
                    .toUpperCase();
                opcode.value = data.opcode.toString(16).toUpperCase();
                operands.value = `${data.operands[0]}, ${data.operands[1]}, ${data.operands[2]}`;
                if (data.halted) {
                    const endTime = performance.now();
                    const runningTime = (endTime - startTime) / 1000;
                    alert(
                        `The virtual machine has halted. Running time: ${runningTime.toFixed(2)} seconds.`,
                    );
                }
                if (displayOn) {
                    updateDisplay(data.memory);
                }
            }

            function loadMemory(memory) {
    memoryData.innerHTML = "";
    memory.forEach((item, index) => {
        const row = document.createElement("tr");

        const binaryValue = item.toString(2).padStart(8, "0");
        const integerValue = item.toString(10);

        row.innerHTML = `
            <td>${index.toString(16).padStart(2, "0").toUpperCase()}</td>
            <td>
                <input type="text" value="${binaryValue}" onchange="syncMemoryFields(${index}, this.value, 'binary')">
            </td>
            <td>
                <input type="text" value="${integerValue}" onchange="syncMemoryFields(${index}, this.value, 'integer')">
            </td>
            <td>${item.toString(16).padStart(2, "0").toUpperCase()}</td>
            <td>${parseFloat(item).toFixed(3)}</td>
        `;
        memoryData.appendChild(row);
    });
}

function loadRegisters(registers) {
    registersData.innerHTML = "";
    registers.forEach((item, index) => {
        const row = document.createElement("tr");

        const binaryValue = item.toString(2).padStart(8, "0");
        const integerValue = item.toString(10);

        row.innerHTML = `
            <td>${index.toString(16).toUpperCase()}</td>
            <td>
                <input type="text" value="${binaryValue}" onchange="syncRegisterFields(${index}, this.value, 'binary')">
            </td>
            <td>
                <input type="text" value="${integerValue}" onchange="syncRegisterFields(${index}, this.value, 'integer')">
            </td>
            <td>${item.toString(16).padStart(2, "0").toUpperCase()}</td>
            <td>${parseFloat(item).toFixed(3)}</td>
        `;
        registersData.appendChild(row);
    });
}

function syncMemoryFields(index, value, type) {
    let newValue;
    if (type === 'binary') {
        newValue = parseInt(value, 2);
    } else if (type === 'integer') {
        newValue = parseInt(value, 10);
    }

    if (!isNaN(newValue)) {
        // Update the memory in the backend
        fetch("/api/vmonline4/update_memory/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify({ index: index, value: newValue }),
        })
        .then(response => response.json())
        .then(data => updateUI(data))
        .catch(error => {
            console.error("Error:", error);
            alert("An error occurred while updating the memory.");
        });
    } else {
        alert("Invalid value");
    }
}

function syncRegisterFields(index, value, type) {
    let newValue;
    if (type === 'binary') {
        newValue = parseInt(value, 2);
    } else if (type === 'integer') {
        newValue = parseInt(value, 10);
    }

    if (!isNaN(newValue)) {
        // Update the registers in the backend
        fetch("/api/vmonline4/update_register/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify({ index: index, value: newValue }),
        })
        .then(response => response.json())
        .then(data => updateUI(data))
        .catch(error => {
            console.error("Error:", error);
            alert("An error occurred while updating the register.");
        });
    } else {
        alert("Invalid value");
    }
}


            function loadMachineCode() {
                fetch("/api/vmonline4/load/")
                    .then((response) => response.json())
                    .then((data) => {
                        updateUI(data);
                        alert("Machine code loaded successfully.");
                    });
            }

            function resetVM() {
                fetch("/api/vmonline4/reset/")
                    .then((response) => response.json())
                    .then((data) => {
                        updateUI(data);
                        alert("Virtual machine reset successfully.");
                    });
            }

            function doStep() {
                fetch("/api/vmonline4/step/")
                    .then((response) => response.json())
                    .then((data) => updateUI(data));
            }

            async function runVM() {
                startTime = performance.now();
                while (true) {
                    const response = await fetch("/api/vmonline4/step/");
                    const data = await response.json();
                    updateUI(data);
                    if (data.halted) break;
                    await new Promise((resolve) =>
                        setTimeout(resolve, stepDelay),
                    );
                }
            }

            function updateSpeed() {
                const speedRange = document.getElementById("speed");
                const speedValue = parseInt(speedRange.value, 10);
                stepDelay = (100 - speedValue) * 10; // 0ms to 1000ms delay
            }

            function displayAssemblyCode(code) {
                assemblyCode.textContent = code;
            }

            function displayMachineCode(code) {
                machineCode.textContent = code;
            }

            function stripComments(code) {
                return code
                    .split("\n")
                    .map((line) => line.split(";")[0].trim())
                    .filter((line) => line.length > 0)
                    .join("\n");
            }

            function editMemory(index, value) {
                const newValue = parseInt(value, 16);
                if (!isNaN(newValue)) {
                    fetch("/api/vmonline4/update_memory/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": getCookie("csrftoken"),
                        },
                        body: JSON.stringify({ index: index, value: newValue }),
                    })
                        .then((response) => response.json())
                        .then((data) => updateUI(data))
                        .catch((error) => {
                            console.error("Error:", error);
                            alert(
                                "An error occurred while updating the memory.",
                            );
                        });
                } else {
                    alert("Invalid hex value");
                }
            }

            function updateDisplay(memory) {
                const displaySize = 32;
                const scale = 20; // Scale each bit to 20x20 pixels
                ctx.clearRect(0, 0, displayCanvas.width, displayCanvas.height);

                for (let row = 0; row < displaySize; row++) {
                    for (let col = 0; col < displaySize; col++) {
                        const byteIndex =
                            0x80 + Math.floor((row * displaySize + col) / 8);
                        const bitIndex = 7 - (col % 8);
                        const byte = memory[byteIndex];
                        const color = byte & (1 << bitIndex) ? 255 : 0;

                        ctx.fillStyle = `rgb(${color}, ${color}, ${color})`;
                        ctx.fillRect(col * scale, row * scale, scale, scale);
                    }
                }
            }

            function toggleDisplay() {
                displayOn = !displayOn;
                if (displayOn) {
                    alert("Display turned on.");
                } else {
                    ctx.clearRect(
                        0,
                        0,
                        displayCanvas.width,
                        displayCanvas.height,
                    );
                    alert("Display turned off.");
                }
            }

            function saveDisplay() {
                const link = document.createElement("a");
                link.download = "display.png";
                link.href = displayCanvas.toDataURL("image/png");
                link.click();
            }

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== "") {
                    const cookies = document.cookie.split(";");
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (
                            cookie.substring(0, name.length + 1) ===
                            name + "="
                        ) {
                            cookieValue = decodeURIComponent(
                                cookie.substring(name.length + 1),
                            );
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            document
                .getElementById("input-file")
                .addEventListener("change", function (event) {
                    const file = event.target.files[0];
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const content = e.target.result;
                        const strippedContent = stripComments(content);
                        displayAssemblyCode(strippedContent);
                    };
                    reader.readAsText(file);
                });

            document
                .getElementById("upload-form")
                .addEventListener("submit", function (event) {
                    event.preventDefault();
                    const formData = new FormData();
                    const inputFile =
                        document.getElementById("input-file").files[0];
                    formData.append("input_file", inputFile);

                    const csrftoken = getCookie("csrftoken");
                    fetch("/api/upload_file/", {
                        method: "POST",
                        headers: { "X-CSRFToken": csrftoken },
                        body: formData,
                    })
                        .then((response) => response.json())
                        .then((data) => {
                            if (data.status === "assembled") {
                                console.log("Machine code:", data.machine_code);
                                displayMachineCode(data.machine_code);
                                alert(
                                    "File uploaded and assembled successfully!",
                                );
                            } else {
                                alert("Error: " + data.message);
                            }
                        })
                        .catch((error) => {
                            console.error("Error:", error);
                            alert(
                                "An error occurred while uploading the file.",
                            );
                        });
                });

            window.onload = resetVM;
        </script>
    </body>
</html>
